

============================== 2025-05-22 10:03:17.035352 | 8478e297-97f4-430a-94f2-827f636438e9 ==============================
[0m10:03:17.035388 [info ] [MainThread]: Running with dbt=1.3.0
[0m10:03:17.036905 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/usr/app/dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m10:03:17.038119 [debug] [MainThread]: Tracking: tracking
[0m10:03:17.044192 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8226292280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8226292370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8226292310>]}
[0m10:03:17.353166 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:03:17.354368 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:03:17.372948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225ba40d0>]}
[0m10:03:17.413538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225f64310>]}
[0m10:03:17.419647 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 289 macros, 0 operations, 0 seed files, 2 sources, 0 exposures, 0 metrics
[0m10:03:17.422069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225f641c0>]}
[0m10:03:17.427674 [info ] [MainThread]: 
[0m10:03:17.430792 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:03:17.437404 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db"
[0m10:03:17.479349 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db"
[0m10:03:17.481642 [debug] [ThreadPool]: On list_nyc_taxi_db: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db"} */

    select distinct nspname from pg_namespace
  
[0m10:03:17.483640 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:17.503425 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.02 seconds
[0m10:03:17.507105 [debug] [ThreadPool]: On list_nyc_taxi_db: Close
[0m10:03:17.513283 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db_public"
[0m10:03:17.538229 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:03:17.541752 [debug] [ThreadPool]: On list_nyc_taxi_db_public: BEGIN
[0m10:03:17.545124 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:17.559305 [debug] [ThreadPool]: SQL status: BEGIN in 0.01 seconds
[0m10:03:17.560876 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:03:17.562337 [debug] [ThreadPool]: On list_nyc_taxi_db_public: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db_public"} */
select
      'nyc_taxi_db' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'nyc_taxi_db' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  
[0m10:03:17.568444 [debug] [ThreadPool]: SQL status: SELECT 10 in 0.0 seconds
[0m10:03:17.644888 [debug] [ThreadPool]: On list_nyc_taxi_db_public: ROLLBACK
[0m10:03:17.649046 [debug] [ThreadPool]: On list_nyc_taxi_db_public: Close
[0m10:03:17.662691 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:17.669044 [debug] [MainThread]: On master: BEGIN
[0m10:03:17.670816 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:03:17.682753 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:03:17.687075 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:17.688581 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:03:17.723216 [debug] [MainThread]: SQL status: SELECT 2 in 0.03 seconds
[0m10:03:17.727305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225ae8ca0>]}
[0m10:03:17.729471 [debug] [MainThread]: On master: ROLLBACK
[0m10:03:17.731343 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:17.732942 [debug] [MainThread]: On master: BEGIN
[0m10:03:17.734838 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:03:17.736053 [debug] [MainThread]: On master: COMMIT
[0m10:03:17.737306 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:17.738587 [debug] [MainThread]: On master: COMMIT
[0m10:03:17.739995 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:03:17.742078 [debug] [MainThread]: On master: Close
[0m10:03:17.744630 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:03:17.746470 [info ] [MainThread]: 
[0m10:03:17.759280 [debug] [Thread-1  ]: Began running node model.nyc_taxi.source_dim_weather
[0m10:03:17.759727 [debug] [Thread-2  ]: Began running node model.nyc_taxi.source_fact_taxi_trips
[0m10:03:17.761223 [info ] [Thread-1  ]: 1 of 5 START sql view model public.source_dim_weather .......................... [RUN]
[0m10:03:17.762910 [info ] [Thread-2  ]: 2 of 5 START sql view model public.source_fact_taxi_trips ...................... [RUN]
[0m10:03:17.765460 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:17.768164 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:17.769975 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.source_dim_weather
[0m10:03:17.771259 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.source_fact_taxi_trips
[0m10:03:17.773049 [debug] [Thread-1  ]: Compiling model.nyc_taxi.source_dim_weather
[0m10:03:17.775741 [debug] [Thread-2  ]: Compiling model.nyc_taxi.source_fact_taxi_trips
[0m10:03:17.785932 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.source_dim_weather"
[0m10:03:17.796101 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:17.813154 [debug] [Thread-1  ]: finished collecting timing info
[0m10:03:17.814783 [debug] [Thread-2  ]: finished collecting timing info
[0m10:03:17.815630 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.source_dim_weather
[0m10:03:17.818840 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.source_fact_taxi_trips
[0m10:03:17.977159 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.source_dim_weather"
[0m10:03:17.978491 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:17.991324 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:17.993428 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: BEGIN
[0m10:03:17.995224 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:17.995728 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:17.999877 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: BEGIN
[0m10:03:18.007639 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:03:18.010244 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:03:18.012396 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:18.015675 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */

  create view "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" as (
    

SELECT
    timestamp,
    temperature,
    humidity,
    wind_speed,
    weather_condition,
    weather_description,
    weather_category,
    hour_of_day,
    day_of_week
FROM
    "nyc_taxi_db"."public"."dim_weather"
  );
[0m10:03:18.021177 [debug] [Thread-1  ]: SQL status: CREATE VIEW in 0.0 seconds
[0m10:03:18.039460 [debug] [Thread-2  ]: SQL status: BEGIN in 0.03 seconds
[0m10:03:18.048980 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:18.049839 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:18.051203 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather" rename to "source_dim_weather__dbt_backup"
[0m10:03:18.052404 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */

  create view "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" as (
    

-- Échantillonnage stratifié pour conserver la représentativité
WITH taxi_sample AS (
    SELECT 
        *,
        -- Utiliser NTILE pour créer des groupes stratifiés par heure et jour
        NTILE(1000) OVER (
            PARTITION BY pickup_hour, pickup_day_of_week 
            ORDER BY pickup_datetime
        ) as sample_group
    FROM "nyc_taxi_db"."public"."fact_taxi_trips"
    WHERE 
        -- Filtrer sur une période spécifique pour réduire encore plus si nécessaire
        pickup_datetime >= '2022-01-01'
        AND pickup_datetime < '2022-04-01'  -- 3 mois au lieu de 2 ans
),

-- Prendre seulement les 3 premiers groupes de chaque strate (≈ 0.3% des données)
representative_sample AS (
    SELECT 
        pickup_datetime,
        dropoff_datetime,
        trip_duration_minutes,
        distance_km,
        distance_bucket,
        fare_amount,
        tip_amount,
        tip_percentage,
        payment_type,
        pickup_hour,
        pickup_day_of_week,
        passenger_count,
        pickup_location_id,
        dropoff_location_id
    FROM taxi_sample
    WHERE sample_group <= 3  -- Prendre seulement les 3 premiers groupes
)

SELECT * FROM representative_sample
  );
[0m10:03:18.055861 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.065623 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:18.066061 [debug] [Thread-2  ]: SQL status: CREATE VIEW in 0.01 seconds
[0m10:03:18.067545 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" rename to "source_dim_weather"
[0m10:03:18.074964 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:18.076745 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.077326 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips" rename to "source_fact_taxi_trips__dbt_backup"
[0m10:03:18.106839 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.01 seconds
[0m10:03:18.135448 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:18.159035 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:03:18.159489 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" rename to "source_fact_taxi_trips"
[0m10:03:18.168896 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:18.180314 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.01 seconds
[0m10:03:18.181476 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:03:18.187437 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:03:18.194842 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:18.195349 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m10:03:18.196857 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:03:18.213541 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:03:18.231093 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
drop view if exists "nyc_taxi_db"."public"."source_dim_weather__dbt_backup" cascade
[0m10:03:18.234998 [debug] [Thread-2  ]: SQL status: COMMIT in 0.01 seconds
[0m10:03:18.246074 [debug] [Thread-1  ]: SQL status: DROP VIEW in 0.01 seconds
[0m10:03:18.247768 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:03:18.257868 [debug] [Thread-1  ]: finished collecting timing info
[0m10:03:18.259877 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
drop view if exists "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_backup" cascade
[0m10:03:18.261781 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: Close
[0m10:03:18.268063 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225b73610>]}
[0m10:03:18.268882 [debug] [Thread-2  ]: SQL status: DROP VIEW in 0.01 seconds
[0m10:03:18.274339 [info ] [Thread-1  ]: 1 of 5 OK created sql view model public.source_dim_weather ..................... [[32mCREATE VIEW[0m in 0.50s]
[0m10:03:18.279150 [debug] [Thread-2  ]: finished collecting timing info
[0m10:03:18.281791 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.source_dim_weather
[0m10:03:18.283688 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: Close
[0m10:03:18.290295 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225b14e20>]}
[0m10:03:18.297383 [info ] [Thread-2  ]: 2 of 5 OK created sql view model public.source_fact_taxi_trips ................. [[32mCREATE VIEW[0m in 0.52s]
[0m10:03:18.306717 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.source_fact_taxi_trips
[0m10:03:18.316043 [debug] [Thread-4  ]: Began running node model.nyc_taxi.trip_enriched
[0m10:03:18.318088 [info ] [Thread-4  ]: 3 of 5 START sql table model public.trip_enriched .............................. [RUN]
[0m10:03:18.321173 [debug] [Thread-4  ]: Acquiring new postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.323207 [debug] [Thread-4  ]: Began compiling node model.nyc_taxi.trip_enriched
[0m10:03:18.374541 [debug] [Thread-4  ]: Compiling model.nyc_taxi.trip_enriched
[0m10:03:18.405073 [debug] [Thread-4  ]: Writing injected SQL for node "model.nyc_taxi.trip_enriched"
[0m10:03:18.456511 [debug] [Thread-4  ]: finished collecting timing info
[0m10:03:18.463692 [debug] [Thread-4  ]: Began executing node model.nyc_taxi.trip_enriched
[0m10:03:18.552417 [debug] [Thread-4  ]: Writing runtime sql for node "model.nyc_taxi.trip_enriched"
[0m10:03:18.565346 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.567205 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: BEGIN
[0m10:03:18.568493 [debug] [Thread-4  ]: Opening a new connection, currently in state init
[0m10:03:18.579881 [debug] [Thread-4  ]: SQL status: BEGIN in 0.01 seconds
[0m10:03:18.581405 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.582780 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp"
  as (
    

WITH taxi_trips AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_fact_taxi_trips"
),

weather AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_dim_weather"
),

-- Créer une jointure simple basée sur l'heure et le jour
weather_simplified AS (
    SELECT 
        hour_of_day,
        day_of_week,
        AVG(temperature) as avg_temperature,
        AVG(humidity) as avg_humidity,
        AVG(wind_speed) as avg_wind_speed,
        -- Utiliser la première valeur non-null pour les catégories
        MIN(weather_condition) as weather_condition,
        MIN(weather_category) as weather_category
    FROM weather
    WHERE temperature IS NOT NULL 
      AND hour_of_day IS NOT NULL 
      AND day_of_week IS NOT NULL
    GROUP BY hour_of_day, day_of_week
)

SELECT
    t.pickup_datetime,
    t.dropoff_datetime,
    t.trip_duration_minutes,
    t.distance_km,
    t.distance_bucket,
    t.fare_amount,
    t.tip_amount,
    t.tip_percentage,
    t.payment_type,
    t.pickup_hour,
    t.pickup_day_of_week,
    t.passenger_count,
    t.pickup_location_id,
    t.dropoff_location_id,
    
    -- Données météo jointées
    w.avg_temperature as temperature,
    w.avg_humidity as humidity,
    w.avg_wind_speed as wind_speed,
    w.weather_condition,
    w.weather_category
FROM
    taxi_trips t
LEFT JOIN
    weather_simplified w
    -- Jointure simple sur heure et jour de la semaine
    ON t.pickup_hour = w.hour_of_day 
    AND t.pickup_day_of_week = w.day_of_week
  );
  
[0m10:03:18.595346 [debug] [Thread-4  ]: SQL status: SELECT 0 in 0.01 seconds
[0m10:03:18.602893 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.604434 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched" rename to "trip_enriched__dbt_backup"
[0m10:03:18.606454 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.614014 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.615109 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp" rename to "trip_enriched"
[0m10:03:18.616744 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.629536 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:03:18.630961 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.632120 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:03:18.635826 [debug] [Thread-4  ]: SQL status: COMMIT in 0.0 seconds
[0m10:03:18.641861 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:03:18.642922 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
drop table if exists "nyc_taxi_db"."public"."trip_enriched__dbt_backup" cascade
[0m10:03:18.646828 [debug] [Thread-4  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:03:18.651483 [debug] [Thread-4  ]: finished collecting timing info
[0m10:03:18.653551 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: Close
[0m10:03:18.655910 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225b19d90>]}
[0m10:03:18.657851 [info ] [Thread-4  ]: 3 of 5 OK created sql table model public.trip_enriched ......................... [[32mSELECT 0[0m in 0.34s]
[0m10:03:18.702361 [debug] [Thread-4  ]: Finished running node model.nyc_taxi.trip_enriched
[0m10:03:18.730686 [debug] [Thread-1  ]: Began running node model.nyc_taxi.high_value_customers
[0m10:03:18.731157 [debug] [Thread-2  ]: Began running node model.nyc_taxi.trip_summary_per_hour
[0m10:03:18.732668 [info ] [Thread-1  ]: 4 of 5 START sql table model public.high_value_customers ....................... [RUN]
[0m10:03:18.734291 [info ] [Thread-2  ]: 5 of 5 START sql table model public.trip_summary_per_hour ...................... [RUN]
[0m10:03:18.736955 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.high_value_customers"
[0m10:03:18.739115 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.740067 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.high_value_customers
[0m10:03:18.742457 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.trip_summary_per_hour
[0m10:03:18.744285 [debug] [Thread-1  ]: Compiling model.nyc_taxi.high_value_customers
[0m10:03:18.754769 [debug] [Thread-2  ]: Compiling model.nyc_taxi.trip_summary_per_hour
[0m10:03:18.763219 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.high_value_customers"
[0m10:03:18.769071 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.777747 [debug] [Thread-1  ]: finished collecting timing info
[0m10:03:18.779675 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.high_value_customers
[0m10:03:18.780274 [debug] [Thread-2  ]: finished collecting timing info
[0m10:03:18.791540 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.high_value_customers"
[0m10:03:18.792617 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.trip_summary_per_hour
[0m10:03:18.805068 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.820730 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:03:18.822022 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.822855 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: BEGIN
[0m10:03:18.824963 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: BEGIN
[0m10:03:18.826472 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:18.827940 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:18.839139 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:03:18.840087 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m10:03:18.843361 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:03:18.845696 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.849841 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
)

SELECT
    pickup_hour,
    weather_category,
    COUNT(*) AS num_trips,
    AVG(trip_duration_minutes) AS avg_trip_duration,
    AVG(tip_percentage) AS avg_tip_percentage,
    AVG(fare_amount) AS avg_fare_amount,
    AVG(distance_km) AS avg_distance
FROM
    trip_data
GROUP BY
    pickup_hour,
    weather_category
  );
  
[0m10:03:18.847618 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */

  
    

  create  table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE pickup_hour IS NOT NULL
      AND trip_duration_minutes IS NOT NULL
      AND fare_amount IS NOT NULL
)

SELECT
    pickup_hour,
    COALESCE(weather_category, 'Unknown') as weather_category,
    COUNT(*) AS num_trips,
    ROUND(AVG(trip_duration_minutes), 2) AS avg_trip_duration,
    ROUND(AVG(COALESCE(tip_percentage, 0)), 2) AS avg_tip_percentage,
    ROUND(AVG(fare_amount), 2) AS avg_fare_amount,
    ROUND(AVG(COALESCE(distance_km, 0)), 2) AS avg_distance,
    
    -- Statistiques supplémentaires
    MIN(fare_amount) as min_fare,
    MAX(fare_amount) as max_fare,
    ROUND(STDDEV(fare_amount), 2) as stddev_fare
FROM trip_data
GROUP BY pickup_hour, COALESCE(weather_category, 'Unknown')
HAVING COUNT(*) >= 1  -- Au moins 1 trip par groupe
ORDER BY pickup_hour, num_trips DESC
  );
  
[0m10:03:18.853570 [debug] [Thread-1  ]: Postgres adapter: Postgres error: function round(double precision, integer) does not exist
LINE 22:     ROUND(AVG(trip_duration_minutes), 2) AS avg_trip_duratio...
             ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.

[0m10:03:18.855248 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: ROLLBACK
[0m10:03:18.859987 [debug] [Thread-1  ]: finished collecting timing info
[0m10:03:18.862026 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: Close
[0m10:03:18.865328 [debug] [Thread-1  ]: Database Error in model high_value_customers (models/marts/high_value_customers.sql)
  function round(double precision, integer) does not exist
  LINE 22:     ROUND(AVG(trip_duration_minutes), 2) AS avg_trip_duratio...
               ^
  HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
  compiled Code at target/run/nyc_taxi/models/marts/high_value_customers.sql
[0m10:03:18.865884 [debug] [Thread-2  ]: SQL status: SELECT 0 in 0.01 seconds
[0m10:03:18.867502 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f82289b0f70>]}
[0m10:03:18.879634 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.887607 [error] [Thread-1  ]: 4 of 5 ERROR creating sql table model public.high_value_customers .............. [[31mERROR[0m in 0.13s]
[0m10:03:18.893527 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour" rename to "trip_summary_per_hour__dbt_backup"
[0m10:03:18.902346 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.high_value_customers
[0m10:03:18.907345 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.924093 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.933632 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp" rename to "trip_summary_per_hour"
[0m10:03:18.937024 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:03:18.944829 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:03:18.947328 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

        CREATE INDEX IF NOT EXISTS idx_trip_summary_per_hour_pickup_datetime ON "nyc_taxi_db"."public"."trip_summary_per_hour" (pickup_datetime)
      
[0m10:03:18.951600 [debug] [Thread-2  ]: Postgres adapter: Postgres error: column "pickup_datetime" does not exist

[0m10:03:18.953253 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: ROLLBACK
[0m10:03:18.955143 [debug] [Thread-2  ]: finished collecting timing info
[0m10:03:18.956489 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: Close
[0m10:03:18.961938 [debug] [Thread-2  ]: Database Error in model trip_summary_per_hour (models/marts/trip_summary_per_hour.sql)
  column "pickup_datetime" does not exist
  compiled Code at target/run/nyc_taxi/models/marts/trip_summary_per_hour.sql
[0m10:03:18.965690 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8478e297-97f4-430a-94f2-827f636438e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8226263310>]}
[0m10:03:18.967860 [error] [Thread-2  ]: 5 of 5 ERROR creating sql table model public.trip_summary_per_hour ............. [[31mERROR[0m in 0.23s]
[0m10:03:18.969664 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.trip_summary_per_hour
[0m10:03:18.974908 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:03:18.978633 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:18.981539 [debug] [MainThread]: On master: BEGIN
[0m10:03:18.983022 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:03:18.995759 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:03:18.997514 [debug] [MainThread]: On master: COMMIT
[0m10:03:19.011314 [debug] [MainThread]: Using postgres connection "master"
[0m10:03:19.015089 [debug] [MainThread]: On master: COMMIT
[0m10:03:19.023306 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:03:19.031832 [debug] [MainThread]: On master: Close
[0m10:03:19.035704 [info ] [MainThread]: 
[0m10:03:19.041684 [info ] [MainThread]: Finished running 2 view models, 3 table models in 0 hours 0 minutes and 1.61 seconds (1.61s).
[0m10:03:19.051014 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:03:19.069213 [debug] [MainThread]: Connection 'model.nyc_taxi.high_value_customers' was properly closed.
[0m10:03:19.077341 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_summary_per_hour' was properly closed.
[0m10:03:19.079430 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_enriched' was properly closed.
[0m10:03:19.136104 [info ] [MainThread]: 
[0m10:03:19.157459 [info ] [MainThread]: [31mCompleted with 2 errors and 0 warnings:[0m
[0m10:03:19.162745 [info ] [MainThread]: 
[0m10:03:19.166643 [error] [MainThread]: [33mDatabase Error in model high_value_customers (models/marts/high_value_customers.sql)[0m
[0m10:03:19.170132 [error] [MainThread]:   function round(double precision, integer) does not exist
[0m10:03:19.179008 [error] [MainThread]:   LINE 22:     ROUND(AVG(trip_duration_minutes), 2) AS avg_trip_duratio...
[0m10:03:19.180866 [error] [MainThread]:                ^
[0m10:03:19.184619 [error] [MainThread]:   HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
[0m10:03:19.195534 [error] [MainThread]:   compiled Code at target/run/nyc_taxi/models/marts/high_value_customers.sql
[0m10:03:19.198341 [info ] [MainThread]: 
[0m10:03:19.203423 [error] [MainThread]: [33mDatabase Error in model trip_summary_per_hour (models/marts/trip_summary_per_hour.sql)[0m
[0m10:03:19.204942 [error] [MainThread]:   column "pickup_datetime" does not exist
[0m10:03:19.206430 [error] [MainThread]:   compiled Code at target/run/nyc_taxi/models/marts/trip_summary_per_hour.sql
[0m10:03:19.210000 [info ] [MainThread]: 
[0m10:03:19.212900 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=2 SKIP=0 TOTAL=5
[0m10:03:19.216015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8225f642e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f82257edac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f82257edd60>]}
[0m10:03:19.218881 [debug] [MainThread]: Flushing usage events


============================== 2025-05-22 10:19:25.555214 | 6a3578e4-b0e7-4ee0-bf37-652fdc76affd ==============================
[0m10:19:25.555248 [info ] [MainThread]: Running with dbt=1.3.0
[0m10:19:25.556980 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/usr/app/dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m10:19:25.558144 [debug] [MainThread]: Tracking: tracking
[0m10:19:25.573581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccd8f8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccd8f7c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccd8f820>]}
[0m10:19:25.661016 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m10:19:25.663059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacd15ec70>]}
[0m10:19:25.940136 [debug] [MainThread]: Parsing macros/timestamps.sql
[0m10:19:25.948423 [debug] [MainThread]: Parsing macros/catalog.sql
[0m10:19:25.952520 [debug] [MainThread]: Parsing macros/adapters.sql
[0m10:19:25.986944 [debug] [MainThread]: Parsing macros/relations.sql
[0m10:19:25.990444 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m10:19:25.993986 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m10:19:25.996479 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m10:19:25.998505 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m10:19:26.001905 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m10:19:26.013586 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m10:19:26.016765 [debug] [MainThread]: Parsing macros/materializations/snapshot_merge.sql
[0m10:19:26.020545 [debug] [MainThread]: Parsing macros/materializations/incremental_strategies.sql
[0m10:19:26.022933 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
[0m10:19:26.026925 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
[0m10:19:26.030890 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
[0m10:19:26.036452 [debug] [MainThread]: Parsing macros/utils/hash.sql
[0m10:19:26.039055 [debug] [MainThread]: Parsing macros/utils/concat.sql
[0m10:19:26.041372 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m10:19:26.044988 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m10:19:26.050343 [debug] [MainThread]: Parsing macros/utils/cast_bool_to_text.sql
[0m10:19:26.053542 [debug] [MainThread]: Parsing macros/utils/data_types.sql
[0m10:19:26.065405 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m10:19:26.068970 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m10:19:26.073613 [debug] [MainThread]: Parsing macros/utils/literal.sql
[0m10:19:26.076256 [debug] [MainThread]: Parsing macros/utils/except.sql
[0m10:19:26.078426 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m10:19:26.080962 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m10:19:26.085288 [debug] [MainThread]: Parsing macros/utils/intersect.sql
[0m10:19:26.087971 [debug] [MainThread]: Parsing macros/utils/date_trunc.sql
[0m10:19:26.090488 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m10:19:26.093582 [debug] [MainThread]: Parsing macros/utils/array_append.sql
[0m10:19:26.096586 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m10:19:26.099056 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m10:19:26.101905 [debug] [MainThread]: Parsing macros/utils/array_concat.sql
[0m10:19:26.104987 [debug] [MainThread]: Parsing macros/utils/replace.sql
[0m10:19:26.107908 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m10:19:26.111694 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m10:19:26.118697 [debug] [MainThread]: Parsing macros/utils/position.sql
[0m10:19:26.121373 [debug] [MainThread]: Parsing macros/utils/length.sql
[0m10:19:26.123896 [debug] [MainThread]: Parsing macros/etc/datetime.sql
[0m10:19:26.137266 [debug] [MainThread]: Parsing macros/etc/statement.sql
[0m10:19:26.146607 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
[0m10:19:26.149487 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
[0m10:19:26.152703 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
[0m10:19:26.154804 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
[0m10:19:26.156898 [debug] [MainThread]: Parsing macros/materializations/configs.sql
[0m10:19:26.161644 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
[0m10:19:26.168713 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
[0m10:19:26.226141 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
[0m10:19:26.254291 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
[0m10:19:26.265024 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
[0m10:19:26.269448 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
[0m10:19:26.274597 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
[0m10:19:26.279177 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
[0m10:19:26.315298 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
[0m10:19:26.341235 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
[0m10:19:26.371801 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
[0m10:19:26.379978 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
[0m10:19:26.393649 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
[0m10:19:26.400497 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
[0m10:19:26.412380 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
[0m10:19:26.418313 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
[0m10:19:26.421957 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
[0m10:19:26.441252 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
[0m10:19:26.466825 [debug] [MainThread]: Parsing macros/materializations/models/incremental/strategies.sql
[0m10:19:26.478273 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
[0m10:19:26.509431 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
[0m10:19:26.530463 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
[0m10:19:26.538404 [debug] [MainThread]: Parsing macros/python_model/python.sql
[0m10:19:26.559293 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
[0m10:19:26.570932 [debug] [MainThread]: Parsing macros/adapters/apply_grants.sql
[0m10:19:26.619447 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
[0m10:19:26.633177 [debug] [MainThread]: Parsing macros/adapters/columns.sql
[0m10:19:26.663943 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
[0m10:19:26.678666 [debug] [MainThread]: Parsing macros/adapters/timestamps.sql
[0m10:19:26.690044 [debug] [MainThread]: Parsing macros/adapters/schema.sql
[0m10:19:26.695446 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
[0m10:19:26.704345 [debug] [MainThread]: Parsing macros/adapters/relation.sql
[0m10:19:26.727829 [debug] [MainThread]: Parsing tests/generic/builtin.sql
[0m10:19:27.246907 [debug] [MainThread]: 1699: static parser successfully parsed intermediate/trip_enriched.sql
[0m10:19:27.279043 [debug] [MainThread]: 1699: static parser successfully parsed marts/high_value_customers.sql
[0m10:19:27.290765 [debug] [MainThread]: 1699: static parser successfully parsed marts/trip_summary_per_hour.sql
[0m10:19:27.303769 [debug] [MainThread]: 1699: static parser successfully parsed staging/source_dim_weather.sql
[0m10:19:27.311205 [debug] [MainThread]: 1699: static parser successfully parsed staging/source_fact_taxi_trips.sql
[0m10:19:27.470807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc9b8070>]}
[0m10:19:27.506528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccca2520>]}
[0m10:19:27.508142 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 289 macros, 0 operations, 0 seed files, 2 sources, 0 exposures, 0 metrics
[0m10:19:27.509458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccc66760>]}
[0m10:19:27.513922 [info ] [MainThread]: 
[0m10:19:27.516828 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:19:27.520609 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db"
[0m10:19:27.548337 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db"
[0m10:19:27.550131 [debug] [ThreadPool]: On list_nyc_taxi_db: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db"} */

    select distinct nspname from pg_namespace
  
[0m10:19:27.551224 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:19:27.581600 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.03 seconds
[0m10:19:27.585249 [debug] [ThreadPool]: On list_nyc_taxi_db: Close
[0m10:19:27.589304 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db_public"
[0m10:19:27.600738 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:19:27.602258 [debug] [ThreadPool]: On list_nyc_taxi_db_public: BEGIN
[0m10:19:27.603627 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:19:27.612614 [debug] [ThreadPool]: SQL status: BEGIN in 0.01 seconds
[0m10:19:27.613975 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:19:27.615102 [debug] [ThreadPool]: On list_nyc_taxi_db_public: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db_public"} */
select
      'nyc_taxi_db' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'nyc_taxi_db' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  
[0m10:19:27.626123 [debug] [ThreadPool]: SQL status: SELECT 10 in 0.01 seconds
[0m10:19:27.628888 [debug] [ThreadPool]: On list_nyc_taxi_db_public: ROLLBACK
[0m10:19:27.630337 [debug] [ThreadPool]: On list_nyc_taxi_db_public: Close
[0m10:19:27.638505 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:27.639700 [debug] [MainThread]: On master: BEGIN
[0m10:19:27.640685 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:19:27.647870 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:19:27.649119 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:27.650110 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:19:27.693895 [debug] [MainThread]: SQL status: SELECT 2 in 0.04 seconds
[0m10:19:27.698567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccd17cd0>]}
[0m10:19:27.701369 [debug] [MainThread]: On master: ROLLBACK
[0m10:19:27.702849 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:27.704285 [debug] [MainThread]: On master: BEGIN
[0m10:19:27.706083 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:19:27.707089 [debug] [MainThread]: On master: COMMIT
[0m10:19:27.708079 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:27.709160 [debug] [MainThread]: On master: COMMIT
[0m10:19:27.710730 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:19:27.711704 [debug] [MainThread]: On master: Close
[0m10:19:27.713697 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:19:27.715332 [info ] [MainThread]: 
[0m10:19:27.739736 [debug] [Thread-1  ]: Began running node model.nyc_taxi.source_dim_weather
[0m10:19:27.739992 [debug] [Thread-2  ]: Began running node model.nyc_taxi.source_fact_taxi_trips
[0m10:19:27.740990 [info ] [Thread-1  ]: 1 of 5 START sql view model public.source_dim_weather .......................... [RUN]
[0m10:19:27.742071 [info ] [Thread-2  ]: 2 of 5 START sql view model public.source_fact_taxi_trips ...................... [RUN]
[0m10:19:27.744316 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:27.745991 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:27.746838 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.source_dim_weather
[0m10:19:27.748635 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.source_fact_taxi_trips
[0m10:19:27.750148 [debug] [Thread-1  ]: Compiling model.nyc_taxi.source_dim_weather
[0m10:19:27.751577 [debug] [Thread-2  ]: Compiling model.nyc_taxi.source_fact_taxi_trips
[0m10:19:27.760783 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.source_dim_weather"
[0m10:19:27.770517 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:27.785956 [debug] [Thread-1  ]: finished collecting timing info
[0m10:19:27.788171 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.source_dim_weather
[0m10:19:27.789850 [debug] [Thread-2  ]: finished collecting timing info
[0m10:19:27.823790 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.source_fact_taxi_trips
[0m10:19:27.974748 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.source_dim_weather"
[0m10:19:27.977267 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:27.998523 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.003545 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: BEGIN
[0m10:19:28.006274 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.007220 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:19:28.008637 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: BEGIN
[0m10:19:28.012869 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:19:28.019313 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.021254 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.023929 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */

  create view "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" as (
    

SELECT
    timestamp,
    temperature,
    humidity,
    wind_speed,
    weather_condition,
    weather_description,
    weather_category,
    hour_of_day,
    day_of_week
FROM
    "nyc_taxi_db"."public"."dim_weather"
  );
[0m10:19:28.025601 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.026894 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.028127 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */

  create view "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" as (
    

-- Échantillonnage stratifié pour conserver la représentativité
WITH taxi_sample AS (
    SELECT 
        *,
        -- Utiliser NTILE pour créer des groupes stratifiés par heure et jour
        NTILE(1000) OVER (
            PARTITION BY pickup_hour, pickup_day_of_week 
            ORDER BY pickup_datetime
        ) as sample_group
    FROM "nyc_taxi_db"."public"."fact_taxi_trips"
    WHERE 
        -- Filtrer sur une période spécifique pour réduire encore plus si nécessaire
        pickup_datetime >= '2022-01-01'
        AND pickup_datetime < '2022-04-01'  -- 3 mois au lieu de 2 ans
),

-- Prendre seulement les 3 premiers groupes de chaque strate (≈ 0.3% des données)
representative_sample AS (
    SELECT 
        pickup_datetime,
        dropoff_datetime,
        trip_duration_minutes,
        distance_km,
        distance_bucket,
        fare_amount,
        tip_amount,
        tip_percentage,
        payment_type,
        pickup_hour,
        pickup_day_of_week,
        passenger_count,
        pickup_location_id,
        dropoff_location_id
    FROM taxi_sample
    WHERE sample_group <= 3  -- Prendre seulement les 3 premiers groupes
)

SELECT * FROM representative_sample
  );
[0m10:19:28.048818 [debug] [Thread-2  ]: SQL status: CREATE VIEW in 0.02 seconds
[0m10:19:28.061183 [debug] [Thread-1  ]: SQL status: CREATE VIEW in 0.04 seconds
[0m10:19:28.069771 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.085454 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.086406 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips" rename to "source_fact_taxi_trips__dbt_backup"
[0m10:19:28.088878 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather" rename to "source_dim_weather__dbt_backup"
[0m10:19:28.096380 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.103868 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.01 seconds
[0m10:19:28.106981 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.113744 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.114663 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" rename to "source_dim_weather"
[0m10:19:28.115778 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" rename to "source_fact_taxi_trips"
[0m10:19:28.117763 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.118901 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.184917 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:19:28.187655 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:19:28.188632 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.189701 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.190626 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:19:28.191605 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:19:28.194537 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m10:19:28.195313 [debug] [Thread-2  ]: SQL status: COMMIT in 0.0 seconds
[0m10:19:28.204041 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:19:28.207933 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:19:28.209226 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
drop view if exists "nyc_taxi_db"."public"."source_dim_weather__dbt_backup" cascade
[0m10:19:28.210225 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
drop view if exists "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_backup" cascade
[0m10:19:28.217419 [debug] [Thread-2  ]: SQL status: DROP VIEW in 0.01 seconds
[0m10:19:28.218178 [debug] [Thread-1  ]: SQL status: DROP VIEW in 0.01 seconds
[0m10:19:28.220362 [debug] [Thread-2  ]: finished collecting timing info
[0m10:19:28.222456 [debug] [Thread-1  ]: finished collecting timing info
[0m10:19:28.223547 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: Close
[0m10:19:28.224483 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: Close
[0m10:19:28.226242 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feaccc407f0>]}
[0m10:19:28.227711 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc8e08b0>]}
[0m10:19:28.228848 [info ] [Thread-2  ]: 2 of 5 OK created sql view model public.source_fact_taxi_trips ................. [[32mCREATE VIEW[0m in 0.48s]
[0m10:19:28.229759 [info ] [Thread-1  ]: 1 of 5 OK created sql view model public.source_dim_weather ..................... [[32mCREATE VIEW[0m in 0.48s]
[0m10:19:28.231140 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.source_fact_taxi_trips
[0m10:19:28.232428 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.source_dim_weather
[0m10:19:28.235396 [debug] [Thread-4  ]: Began running node model.nyc_taxi.trip_enriched
[0m10:19:28.236522 [info ] [Thread-4  ]: 3 of 5 START sql table model public.trip_enriched .............................. [RUN]
[0m10:19:28.238056 [debug] [Thread-4  ]: Acquiring new postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.238991 [debug] [Thread-4  ]: Began compiling node model.nyc_taxi.trip_enriched
[0m10:19:28.239901 [debug] [Thread-4  ]: Compiling model.nyc_taxi.trip_enriched
[0m10:19:28.245673 [debug] [Thread-4  ]: Writing injected SQL for node "model.nyc_taxi.trip_enriched"
[0m10:19:28.256639 [debug] [Thread-4  ]: finished collecting timing info
[0m10:19:28.258220 [debug] [Thread-4  ]: Began executing node model.nyc_taxi.trip_enriched
[0m10:19:28.292385 [debug] [Thread-4  ]: Writing runtime sql for node "model.nyc_taxi.trip_enriched"
[0m10:19:28.304309 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.305424 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: BEGIN
[0m10:19:28.306411 [debug] [Thread-4  ]: Opening a new connection, currently in state init
[0m10:19:28.313903 [debug] [Thread-4  ]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.315052 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.315896 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp"
  as (
    

WITH taxi_trips AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_fact_taxi_trips"
),

weather AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_dim_weather"
),

-- Créer une jointure simple basée sur l'heure et le jour
weather_simplified AS (
    SELECT 
        hour_of_day,
        day_of_week,
        AVG(temperature) as avg_temperature,
        AVG(humidity) as avg_humidity,
        AVG(wind_speed) as avg_wind_speed,
        -- Utiliser la première valeur non-null pour les catégories
        MIN(weather_condition) as weather_condition,
        MIN(weather_category) as weather_category
    FROM weather
    WHERE temperature IS NOT NULL 
      AND hour_of_day IS NOT NULL 
      AND day_of_week IS NOT NULL
    GROUP BY hour_of_day, day_of_week
)

SELECT
    t.pickup_datetime,
    t.dropoff_datetime,
    t.trip_duration_minutes,
    t.distance_km,
    t.distance_bucket,
    t.fare_amount,
    t.tip_amount,
    t.tip_percentage,
    t.payment_type,
    t.pickup_hour,
    t.pickup_day_of_week,
    t.passenger_count,
    t.pickup_location_id,
    t.dropoff_location_id,
    
    -- Données météo jointées
    w.avg_temperature as temperature,
    w.avg_humidity as humidity,
    w.avg_wind_speed as wind_speed,
    w.weather_condition,
    w.weather_category
FROM
    taxi_trips t
LEFT JOIN
    weather_simplified w
    -- Jointure simple sur heure et jour de la semaine
    ON t.pickup_hour = w.hour_of_day 
    AND t.pickup_day_of_week = w.day_of_week
  );
  
[0m10:19:28.654729 [debug] [Thread-4  ]: SQL status: SELECT 522 in 0.34 seconds
[0m10:19:28.660162 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.661243 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched" rename to "trip_enriched__dbt_backup"
[0m10:19:28.663548 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.670319 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.672776 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp" rename to "trip_enriched"
[0m10:19:28.674884 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.687250 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:19:28.689341 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.690778 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:19:28.696081 [debug] [Thread-4  ]: SQL status: COMMIT in 0.0 seconds
[0m10:19:28.704297 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:19:28.709037 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
drop table if exists "nyc_taxi_db"."public"."trip_enriched__dbt_backup" cascade
[0m10:19:28.714067 [debug] [Thread-4  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:19:28.718780 [debug] [Thread-4  ]: finished collecting timing info
[0m10:19:28.721577 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: Close
[0m10:19:28.724328 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc8c3a90>]}
[0m10:19:28.726036 [info ] [Thread-4  ]: 3 of 5 OK created sql table model public.trip_enriched ......................... [[32mSELECT 522[0m in 0.49s]
[0m10:19:28.727933 [debug] [Thread-4  ]: Finished running node model.nyc_taxi.trip_enriched
[0m10:19:28.730822 [debug] [Thread-2  ]: Began running node model.nyc_taxi.high_value_customers
[0m10:19:28.731209 [debug] [Thread-1  ]: Began running node model.nyc_taxi.trip_summary_per_hour
[0m10:19:28.732956 [info ] [Thread-2  ]: 4 of 5 START sql table model public.high_value_customers ....................... [RUN]
[0m10:19:28.734807 [info ] [Thread-1  ]: 5 of 5 START sql table model public.trip_summary_per_hour ...................... [RUN]
[0m10:19:28.737416 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.739268 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.740626 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.high_value_customers
[0m10:19:28.742005 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.trip_summary_per_hour
[0m10:19:28.743291 [debug] [Thread-2  ]: Compiling model.nyc_taxi.high_value_customers
[0m10:19:28.744524 [debug] [Thread-1  ]: Compiling model.nyc_taxi.trip_summary_per_hour
[0m10:19:28.754524 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.high_value_customers"
[0m10:19:28.762844 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.773484 [debug] [Thread-2  ]: finished collecting timing info
[0m10:19:28.778198 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.high_value_customers
[0m10:19:28.778774 [debug] [Thread-1  ]: finished collecting timing info
[0m10:19:28.794909 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.high_value_customers"
[0m10:19:28.795584 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.trip_summary_per_hour
[0m10:19:28.806807 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.816474 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.818823 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: BEGIN
[0m10:19:28.820465 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:19:28.821095 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.823752 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: BEGIN
[0m10:19:28.825099 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:19:28.831016 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.832454 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.833792 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */

  
    

  create  table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE fare_amount IS NOT NULL 
      AND tip_amount IS NOT NULL
      AND passenger_count IS NOT NULL
      AND passenger_count > 0
),

customer_stats AS (
    SELECT
        -- Utiliser passenger_count et pickup_location_id comme proxy pour identifier les "clients"
        passenger_count,
        pickup_location_id,
        COUNT(*) AS num_trips,
        SUM(fare_amount + COALESCE(tip_amount, 0)) AS total_spent,
        AVG(COALESCE(tip_percentage, 0)) AS avg_tip_percentage
    FROM trip_data
    GROUP BY passenger_count, pickup_location_id
    HAVING COUNT(*) > 0  -- Au moins 1 trip pour éviter les divisions par zéro
)

SELECT
    passenger_count,
    pickup_location_id,
    num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(total_spent AS DECIMAL(10,2)) as total_spent,
    CAST(avg_tip_percentage AS DECIMAL(10,2)) as avg_tip_percentage,
    
    -- Critères ajustés pour l'échantillon
    CASE 
        WHEN num_trips >= 5 AND total_spent >= 100 AND avg_tip_percentage >= 12 
        THEN 'High Value Customer'
        ELSE 'Regular Customer'
    END as customer_category
FROM customer_stats
WHERE 
    num_trips >= 2  -- Ajusté pour l'échantillon (au lieu de 10)
    AND total_spent >= 50  -- Ajusté pour l'échantillon (au lieu de 300)
    AND avg_tip_percentage >= 10  -- Ajusté pour l'échantillon (au lieu de 15)
ORDER BY total_spent DESC
  );
  
[0m10:19:28.835553 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.836934 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.838134 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE pickup_hour IS NOT NULL
      AND trip_duration_minutes IS NOT NULL
      AND fare_amount IS NOT NULL
)

SELECT
    pickup_hour,
    COALESCE(weather_category, 'Unknown') as weather_category,
    COUNT(*) AS num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(AVG(trip_duration_minutes) AS DECIMAL(10,2)) AS avg_trip_duration,
    CAST(AVG(COALESCE(tip_percentage, 0)) AS DECIMAL(10,2)) AS avg_tip_percentage,
    CAST(AVG(fare_amount) AS DECIMAL(10,2)) AS avg_fare_amount,
    CAST(AVG(COALESCE(distance_km, 0)) AS DECIMAL(10,2)) AS avg_distance,
    
    -- Statistiques supplémentaires
    MIN(fare_amount) as min_fare,
    MAX(fare_amount) as max_fare,
    CAST(STDDEV(fare_amount) AS DECIMAL(10,2)) as stddev_fare
FROM trip_data
GROUP BY pickup_hour, COALESCE(weather_category, 'Unknown')
HAVING COUNT(*) >= 1  -- Au moins 1 trip par groupe
ORDER BY pickup_hour, num_trips DESC
  );
  
[0m10:19:28.850709 [debug] [Thread-1  ]: SQL status: SELECT 24 in 0.01 seconds
[0m10:19:28.857468 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.857818 [debug] [Thread-2  ]: SQL status: SELECT 45 in 0.02 seconds
[0m10:19:28.859007 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour" rename to "trip_summary_per_hour__dbt_backup"
[0m10:19:28.864810 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.867047 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.867745 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
alter table "nyc_taxi_db"."public"."high_value_customers" rename to "high_value_customers__dbt_backup"
[0m10:19:28.873284 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.875255 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.875776 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp" rename to "trip_summary_per_hour"
[0m10:19:28.880657 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.882301 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.882750 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
alter table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp" rename to "high_value_customers"
[0m10:19:28.887332 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.889436 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:19:28.890303 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

        CREATE INDEX IF NOT EXISTS idx_trip_summary_per_hour_pickup_hour ON "nyc_taxi_db"."public"."trip_summary_per_hour" (pickup_hour) WHERE pickup_hour IS NOT NULL
      
[0m10:19:28.894643 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:19:28.896928 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */

        CREATE INDEX IF NOT EXISTS idx_high_value_customers_pickup_hour ON "nyc_taxi_db"."public"."high_value_customers" (pickup_hour) WHERE pickup_hour IS NOT NULL
      
[0m10:19:28.899826 [debug] [Thread-2  ]: Postgres adapter: Postgres error: column "pickup_hour" does not exist
LINE 3: ...ublic"."high_value_customers" (pickup_hour) WHERE pickup_hou...
                                                             ^

[0m10:19:28.900473 [debug] [Thread-1  ]: SQL status: CREATE INDEX in 0.0 seconds
[0m10:19:28.901028 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: ROLLBACK
[0m10:19:28.904979 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m10:19:28.906572 [debug] [Thread-2  ]: finished collecting timing info
[0m10:19:28.907330 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.908723 [debug] [Thread-2  ]: On model.nyc_taxi.high_value_customers: Close
[0m10:19:28.909940 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m10:19:28.911814 [debug] [Thread-2  ]: Database Error in model high_value_customers (models/marts/high_value_customers.sql)
  column "pickup_hour" does not exist
  LINE 3: ...ublic"."high_value_customers" (pickup_hour) WHERE pickup_hou...
                                                               ^
  compiled Code at target/run/nyc_taxi/models/marts/high_value_customers.sql
[0m10:19:28.914124 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc854880>]}
[0m10:19:28.914437 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m10:19:28.915601 [error] [Thread-2  ]: 4 of 5 ERROR creating sql table model public.high_value_customers .............. [[31mERROR[0m in 0.18s]
[0m10:19:28.922267 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:19:28.924391 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.high_value_customers
[0m10:19:28.925389 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
drop table if exists "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_backup" cascade
[0m10:19:28.932120 [debug] [Thread-1  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:19:28.935411 [debug] [Thread-1  ]: finished collecting timing info
[0m10:19:28.936580 [debug] [Thread-1  ]: On model.nyc_taxi.trip_summary_per_hour: Close
[0m10:19:28.938487 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a3578e4-b0e7-4ee0-bf37-652fdc76affd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc5e71f0>]}
[0m10:19:28.940221 [info ] [Thread-1  ]: 5 of 5 OK created sql table model public.trip_summary_per_hour ................. [[32mSELECT 24[0m in 0.20s]
[0m10:19:28.941653 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.trip_summary_per_hour
[0m10:19:28.945562 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:19:28.946813 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:28.948106 [debug] [MainThread]: On master: BEGIN
[0m10:19:28.949179 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:19:28.959910 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:19:28.961163 [debug] [MainThread]: On master: COMMIT
[0m10:19:28.962249 [debug] [MainThread]: Using postgres connection "master"
[0m10:19:28.963426 [debug] [MainThread]: On master: COMMIT
[0m10:19:28.965226 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:19:28.966523 [debug] [MainThread]: On master: Close
[0m10:19:28.968886 [info ] [MainThread]: 
[0m10:19:28.970438 [info ] [MainThread]: Finished running 2 view models, 3 table models in 0 hours 0 minutes and 1.45 seconds (1.45s).
[0m10:19:28.971776 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:19:28.973221 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_summary_per_hour' was properly closed.
[0m10:19:28.974319 [debug] [MainThread]: Connection 'model.nyc_taxi.high_value_customers' was properly closed.
[0m10:19:28.975470 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_enriched' was properly closed.
[0m10:19:29.000020 [info ] [MainThread]: 
[0m10:19:29.002165 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m10:19:29.003853 [info ] [MainThread]: 
[0m10:19:29.006544 [error] [MainThread]: [33mDatabase Error in model high_value_customers (models/marts/high_value_customers.sql)[0m
[0m10:19:29.011113 [error] [MainThread]:   column "pickup_hour" does not exist
[0m10:19:29.013583 [error] [MainThread]:   LINE 3: ...ublic"."high_value_customers" (pickup_hour) WHERE pickup_hou...
[0m10:19:29.019264 [error] [MainThread]:                                                                ^
[0m10:19:29.021685 [error] [MainThread]:   compiled Code at target/run/nyc_taxi/models/marts/high_value_customers.sql
[0m10:19:29.023668 [info ] [MainThread]: 
[0m10:19:29.025339 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m10:19:29.026939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc8e08b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc8c3640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feacc8c3eb0>]}
[0m10:19:29.028286 [debug] [MainThread]: Flushing usage events


============================== 2025-05-22 10:21:24.290927 | 45064add-d14a-45b7-a44a-706e8802c5bf ==============================
[0m10:21:24.290958 [info ] [MainThread]: Running with dbt=1.3.0
[0m10:21:24.293006 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/usr/app/dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m10:21:24.293950 [debug] [MainThread]: Tracking: tracking
[0m10:21:24.301115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8034f1280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8034f1370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8034f1310>]}
[0m10:21:24.361694 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m10:21:24.362916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8034ce940>]}
[0m10:21:24.511189 [debug] [MainThread]: Parsing macros/timestamps.sql
[0m10:21:24.515956 [debug] [MainThread]: Parsing macros/catalog.sql
[0m10:21:24.520306 [debug] [MainThread]: Parsing macros/adapters.sql
[0m10:21:24.555413 [debug] [MainThread]: Parsing macros/relations.sql
[0m10:21:24.558605 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m10:21:24.561131 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m10:21:24.563171 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m10:21:24.565109 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m10:21:24.568216 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m10:21:24.578707 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m10:21:24.582092 [debug] [MainThread]: Parsing macros/materializations/snapshot_merge.sql
[0m10:21:24.585363 [debug] [MainThread]: Parsing macros/materializations/incremental_strategies.sql
[0m10:21:24.587504 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
[0m10:21:24.590708 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
[0m10:21:24.593901 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
[0m10:21:24.598962 [debug] [MainThread]: Parsing macros/utils/hash.sql
[0m10:21:24.601425 [debug] [MainThread]: Parsing macros/utils/concat.sql
[0m10:21:24.603798 [debug] [MainThread]: Parsing macros/utils/last_day.sql
[0m10:21:24.607457 [debug] [MainThread]: Parsing macros/utils/any_value.sql
[0m10:21:24.610899 [debug] [MainThread]: Parsing macros/utils/cast_bool_to_text.sql
[0m10:21:24.614267 [debug] [MainThread]: Parsing macros/utils/data_types.sql
[0m10:21:24.626582 [debug] [MainThread]: Parsing macros/utils/dateadd.sql
[0m10:21:24.629987 [debug] [MainThread]: Parsing macros/utils/right.sql
[0m10:21:24.632797 [debug] [MainThread]: Parsing macros/utils/literal.sql
[0m10:21:24.634886 [debug] [MainThread]: Parsing macros/utils/except.sql
[0m10:21:24.636685 [debug] [MainThread]: Parsing macros/utils/bool_or.sql
[0m10:21:24.639075 [debug] [MainThread]: Parsing macros/utils/listagg.sql
[0m10:21:24.644523 [debug] [MainThread]: Parsing macros/utils/intersect.sql
[0m10:21:24.646445 [debug] [MainThread]: Parsing macros/utils/date_trunc.sql
[0m10:21:24.648539 [debug] [MainThread]: Parsing macros/utils/datediff.sql
[0m10:21:24.651038 [debug] [MainThread]: Parsing macros/utils/array_append.sql
[0m10:21:24.653611 [debug] [MainThread]: Parsing macros/utils/escape_single_quotes.sql
[0m10:21:24.655758 [debug] [MainThread]: Parsing macros/utils/safe_cast.sql
[0m10:21:24.658683 [debug] [MainThread]: Parsing macros/utils/array_concat.sql
[0m10:21:24.660945 [debug] [MainThread]: Parsing macros/utils/replace.sql
[0m10:21:24.663262 [debug] [MainThread]: Parsing macros/utils/array_construct.sql
[0m10:21:24.666256 [debug] [MainThread]: Parsing macros/utils/split_part.sql
[0m10:21:24.670253 [debug] [MainThread]: Parsing macros/utils/position.sql
[0m10:21:24.673698 [debug] [MainThread]: Parsing macros/utils/length.sql
[0m10:21:24.675773 [debug] [MainThread]: Parsing macros/etc/datetime.sql
[0m10:21:24.689248 [debug] [MainThread]: Parsing macros/etc/statement.sql
[0m10:21:24.697597 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
[0m10:21:24.699873 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
[0m10:21:24.702461 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
[0m10:21:24.704254 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
[0m10:21:24.705952 [debug] [MainThread]: Parsing macros/materializations/configs.sql
[0m10:21:24.709966 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
[0m10:21:24.716611 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
[0m10:21:24.727913 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
[0m10:21:24.753072 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
[0m10:21:24.760258 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
[0m10:21:24.763612 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
[0m10:21:24.766571 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
[0m10:21:24.769249 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
[0m10:21:24.824844 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
[0m10:21:24.839322 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
[0m10:21:24.854719 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
[0m10:21:24.859972 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
[0m10:21:24.867425 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
[0m10:21:24.872265 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
[0m10:21:24.880552 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
[0m10:21:24.884115 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
[0m10:21:24.886489 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
[0m10:21:24.896998 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
[0m10:21:24.918763 [debug] [MainThread]: Parsing macros/materializations/models/incremental/strategies.sql
[0m10:21:24.927953 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
[0m10:21:24.947535 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
[0m10:21:24.961400 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
[0m10:21:24.964012 [debug] [MainThread]: Parsing macros/python_model/python.sql
[0m10:21:24.971810 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
[0m10:21:24.975961 [debug] [MainThread]: Parsing macros/adapters/apply_grants.sql
[0m10:21:24.995276 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
[0m10:21:24.998526 [debug] [MainThread]: Parsing macros/adapters/columns.sql
[0m10:21:25.011638 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
[0m10:21:25.022341 [debug] [MainThread]: Parsing macros/adapters/timestamps.sql
[0m10:21:25.027292 [debug] [MainThread]: Parsing macros/adapters/schema.sql
[0m10:21:25.031298 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
[0m10:21:25.037638 [debug] [MainThread]: Parsing macros/adapters/relation.sql
[0m10:21:25.058396 [debug] [MainThread]: Parsing tests/generic/builtin.sql
[0m10:21:25.373185 [debug] [MainThread]: 1699: static parser successfully parsed intermediate/trip_enriched.sql
[0m10:21:25.390046 [debug] [MainThread]: 1699: static parser successfully parsed marts/high_value_customers.sql
[0m10:21:25.395117 [debug] [MainThread]: 1699: static parser successfully parsed marts/trip_summary_per_hour.sql
[0m10:21:25.399512 [debug] [MainThread]: 1699: static parser successfully parsed staging/source_dim_weather.sql
[0m10:21:25.404247 [debug] [MainThread]: 1699: static parser successfully parsed staging/source_fact_taxi_trips.sql
[0m10:21:25.503937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802dd50d0>]}
[0m10:21:25.526881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802d82670>]}
[0m10:21:25.528569 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 289 macros, 0 operations, 0 seed files, 2 sources, 0 exposures, 0 metrics
[0m10:21:25.529788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802dd7d90>]}
[0m10:21:25.532999 [info ] [MainThread]: 
[0m10:21:25.535541 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:21:25.538782 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db"
[0m10:21:25.559516 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db"
[0m10:21:25.560856 [debug] [ThreadPool]: On list_nyc_taxi_db: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db"} */

    select distinct nspname from pg_namespace
  
[0m10:21:25.561975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:21:25.570249 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.01 seconds
[0m10:21:25.572749 [debug] [ThreadPool]: On list_nyc_taxi_db: Close
[0m10:21:25.575946 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db_public"
[0m10:21:25.586241 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:21:25.587964 [debug] [ThreadPool]: On list_nyc_taxi_db_public: BEGIN
[0m10:21:25.589073 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:21:25.596660 [debug] [ThreadPool]: SQL status: BEGIN in 0.01 seconds
[0m10:21:25.597981 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m10:21:25.599326 [debug] [ThreadPool]: On list_nyc_taxi_db_public: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db_public"} */
select
      'nyc_taxi_db' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'nyc_taxi_db' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  
[0m10:21:25.603944 [debug] [ThreadPool]: SQL status: SELECT 10 in 0.0 seconds
[0m10:21:25.607390 [debug] [ThreadPool]: On list_nyc_taxi_db_public: ROLLBACK
[0m10:21:25.609155 [debug] [ThreadPool]: On list_nyc_taxi_db_public: Close
[0m10:21:25.617821 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:25.619280 [debug] [MainThread]: On master: BEGIN
[0m10:21:25.620382 [debug] [MainThread]: Opening a new connection, currently in state init
[0m10:21:25.627376 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:21:25.628603 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:25.629631 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m10:21:25.649077 [debug] [MainThread]: SQL status: SELECT 2 in 0.02 seconds
[0m10:21:25.651966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc80348c2b0>]}
[0m10:21:25.654711 [debug] [MainThread]: On master: ROLLBACK
[0m10:21:25.658078 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:25.659091 [debug] [MainThread]: On master: BEGIN
[0m10:21:25.660501 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m10:21:25.661347 [debug] [MainThread]: On master: COMMIT
[0m10:21:25.662085 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:25.662853 [debug] [MainThread]: On master: COMMIT
[0m10:21:25.663801 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:21:25.664716 [debug] [MainThread]: On master: Close
[0m10:21:25.666217 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m10:21:25.667503 [info ] [MainThread]: 
[0m10:21:25.676335 [debug] [Thread-1  ]: Began running node model.nyc_taxi.source_dim_weather
[0m10:21:25.676582 [debug] [Thread-2  ]: Began running node model.nyc_taxi.source_fact_taxi_trips
[0m10:21:25.677526 [info ] [Thread-1  ]: 1 of 5 START sql view model public.source_dim_weather .......................... [RUN]
[0m10:21:25.678832 [info ] [Thread-2  ]: 2 of 5 START sql view model public.source_fact_taxi_trips ...................... [RUN]
[0m10:21:25.680500 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.681836 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.682521 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.source_dim_weather
[0m10:21:25.683945 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.source_fact_taxi_trips
[0m10:21:25.684977 [debug] [Thread-1  ]: Compiling model.nyc_taxi.source_dim_weather
[0m10:21:25.685960 [debug] [Thread-2  ]: Compiling model.nyc_taxi.source_fact_taxi_trips
[0m10:21:25.693083 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.source_dim_weather"
[0m10:21:25.698741 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.705729 [debug] [Thread-2  ]: finished collecting timing info
[0m10:21:25.708622 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.source_fact_taxi_trips
[0m10:21:25.708952 [debug] [Thread-1  ]: finished collecting timing info
[0m10:21:25.732175 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.source_dim_weather
[0m10:21:25.787383 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.787862 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.source_dim_weather"
[0m10:21:25.795922 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.797618 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: BEGIN
[0m10:21:25.798019 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.798859 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:21:25.799894 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: BEGIN
[0m10:21:25.801979 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:21:25.807257 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:21:25.808394 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.809572 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */

  create view "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" as (
    

SELECT
    timestamp,
    temperature,
    humidity,
    wind_speed,
    weather_condition,
    weather_description,
    weather_category,
    hour_of_day,
    day_of_week
FROM
    "nyc_taxi_db"."public"."dim_weather"
  );
[0m10:21:25.810630 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m10:21:25.811718 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.812445 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */

  create view "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" as (
    

-- Échantillonnage stratifié pour conserver la représentativité
WITH taxi_sample AS (
    SELECT 
        *,
        -- Utiliser NTILE pour créer des groupes stratifiés par heure et jour
        NTILE(1000) OVER (
            PARTITION BY pickup_hour, pickup_day_of_week 
            ORDER BY pickup_datetime
        ) as sample_group
    FROM "nyc_taxi_db"."public"."fact_taxi_trips"
    WHERE 
        -- Filtrer sur une période spécifique pour réduire encore plus si nécessaire
        pickup_datetime >= '2022-01-01'
        AND pickup_datetime < '2022-04-01'  -- 3 mois au lieu de 2 ans
),

-- Prendre seulement les 3 premiers groupes de chaque strate (≈ 0.3% des données)
representative_sample AS (
    SELECT 
        pickup_datetime,
        dropoff_datetime,
        trip_duration_minutes,
        distance_km,
        distance_bucket,
        fare_amount,
        tip_amount,
        tip_percentage,
        payment_type,
        pickup_hour,
        pickup_day_of_week,
        passenger_count,
        pickup_location_id,
        dropoff_location_id
    FROM taxi_sample
    WHERE sample_group <= 3  -- Prendre seulement les 3 premiers groupes
)

SELECT * FROM representative_sample
  );
[0m10:21:25.816359 [debug] [Thread-1  ]: SQL status: CREATE VIEW in 0.01 seconds
[0m10:21:25.816576 [debug] [Thread-2  ]: SQL status: CREATE VIEW in 0.0 seconds
[0m10:21:25.826693 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.830723 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.831657 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather" rename to "source_dim_weather__dbt_backup"
[0m10:21:25.832496 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips" rename to "source_fact_taxi_trips__dbt_backup"
[0m10:21:25.834299 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:25.835050 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:25.838592 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.843055 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.844131 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" rename to "source_dim_weather"
[0m10:21:25.845284 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" rename to "source_fact_taxi_trips"
[0m10:21:25.846975 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:25.847920 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:25.879303 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:21:25.880549 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:21:25.881117 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.881837 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.882540 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m10:21:25.883229 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m10:21:25.885537 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m10:21:25.891460 [debug] [Thread-2  ]: SQL status: COMMIT in 0.01 seconds
[0m10:21:25.893067 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m10:21:25.896745 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m10:21:25.897576 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
drop view if exists "nyc_taxi_db"."public"."source_dim_weather__dbt_backup" cascade
[0m10:21:25.898316 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
drop view if exists "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_backup" cascade
[0m10:21:25.901169 [debug] [Thread-1  ]: SQL status: DROP VIEW in 0.0 seconds
[0m10:21:25.901891 [debug] [Thread-2  ]: SQL status: DROP VIEW in 0.0 seconds
[0m10:21:25.903385 [debug] [Thread-1  ]: finished collecting timing info
[0m10:21:25.905215 [debug] [Thread-2  ]: finished collecting timing info
[0m10:21:25.905980 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: Close
[0m10:21:25.906890 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: Close
[0m10:21:25.908626 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8029e2c40>]}
[0m10:21:25.909875 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802c6ff70>]}
[0m10:21:25.910684 [info ] [Thread-1  ]: 1 of 5 OK created sql view model public.source_dim_weather ..................... [[32mCREATE VIEW[0m in 0.23s]
[0m10:21:25.911740 [info ] [Thread-2  ]: 2 of 5 OK created sql view model public.source_fact_taxi_trips ................. [[32mCREATE VIEW[0m in 0.23s]
[0m10:21:25.912914 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.source_dim_weather
[0m10:21:25.913907 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.source_fact_taxi_trips
[0m10:21:25.916579 [debug] [Thread-4  ]: Began running node model.nyc_taxi.trip_enriched
[0m10:21:25.917655 [info ] [Thread-4  ]: 3 of 5 START sql table model public.trip_enriched .............................. [RUN]
[0m10:21:25.919485 [debug] [Thread-4  ]: Acquiring new postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:25.920357 [debug] [Thread-4  ]: Began compiling node model.nyc_taxi.trip_enriched
[0m10:21:25.921106 [debug] [Thread-4  ]: Compiling model.nyc_taxi.trip_enriched
[0m10:21:25.926336 [debug] [Thread-4  ]: Writing injected SQL for node "model.nyc_taxi.trip_enriched"
[0m10:21:25.934242 [debug] [Thread-4  ]: finished collecting timing info
[0m10:21:25.935146 [debug] [Thread-4  ]: Began executing node model.nyc_taxi.trip_enriched
[0m10:21:25.964923 [debug] [Thread-4  ]: Writing runtime sql for node "model.nyc_taxi.trip_enriched"
[0m10:21:25.972218 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:25.973080 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: BEGIN
[0m10:21:25.973927 [debug] [Thread-4  ]: Opening a new connection, currently in state init
[0m10:21:25.980612 [debug] [Thread-4  ]: SQL status: BEGIN in 0.01 seconds
[0m10:21:25.981511 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:25.982318 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp"
  as (
    

WITH taxi_trips AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_fact_taxi_trips"
),

weather AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_dim_weather"
),

-- Créer une jointure simple basée sur l'heure et le jour
weather_simplified AS (
    SELECT 
        hour_of_day,
        day_of_week,
        AVG(temperature) as avg_temperature,
        AVG(humidity) as avg_humidity,
        AVG(wind_speed) as avg_wind_speed,
        -- Utiliser la première valeur non-null pour les catégories
        MIN(weather_condition) as weather_condition,
        MIN(weather_category) as weather_category
    FROM weather
    WHERE temperature IS NOT NULL 
      AND hour_of_day IS NOT NULL 
      AND day_of_week IS NOT NULL
    GROUP BY hour_of_day, day_of_week
)

SELECT
    t.pickup_datetime,
    t.dropoff_datetime,
    t.trip_duration_minutes,
    t.distance_km,
    t.distance_bucket,
    t.fare_amount,
    t.tip_amount,
    t.tip_percentage,
    t.payment_type,
    t.pickup_hour,
    t.pickup_day_of_week,
    t.passenger_count,
    t.pickup_location_id,
    t.dropoff_location_id,
    
    -- Données météo jointées
    w.avg_temperature as temperature,
    w.avg_humidity as humidity,
    w.avg_wind_speed as wind_speed,
    w.weather_condition,
    w.weather_category
FROM
    taxi_trips t
LEFT JOIN
    weather_simplified w
    -- Jointure simple sur heure et jour de la semaine
    ON t.pickup_hour = w.hour_of_day 
    AND t.pickup_day_of_week = w.day_of_week
  );
  
[0m10:21:26.162577 [debug] [Thread-4  ]: SQL status: SELECT 522 in 0.18 seconds
[0m10:21:26.169226 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:26.170450 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched" rename to "trip_enriched__dbt_backup"
[0m10:21:26.172160 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.176746 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:26.177953 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp" rename to "trip_enriched"
[0m10:21:26.179585 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.189099 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:21:26.190346 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:26.191355 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m10:21:26.193498 [debug] [Thread-4  ]: SQL status: COMMIT in 0.0 seconds
[0m10:21:26.197719 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m10:21:26.198931 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
drop table if exists "nyc_taxi_db"."public"."trip_enriched__dbt_backup" cascade
[0m10:21:26.202395 [debug] [Thread-4  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:21:26.205727 [debug] [Thread-4  ]: finished collecting timing info
[0m10:21:26.206844 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: Close
[0m10:21:26.208676 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8029ebd30>]}
[0m10:21:26.210146 [info ] [Thread-4  ]: 3 of 5 OK created sql table model public.trip_enriched ......................... [[32mSELECT 522[0m in 0.29s]
[0m10:21:26.211708 [debug] [Thread-4  ]: Finished running node model.nyc_taxi.trip_enriched
[0m10:21:26.214028 [debug] [Thread-1  ]: Began running node model.nyc_taxi.high_value_customers
[0m10:21:26.214308 [debug] [Thread-2  ]: Began running node model.nyc_taxi.trip_summary_per_hour
[0m10:21:26.215355 [info ] [Thread-1  ]: 4 of 5 START sql table model public.high_value_customers ....................... [RUN]
[0m10:21:26.216432 [info ] [Thread-2  ]: 5 of 5 START sql table model public.trip_summary_per_hour ...................... [RUN]
[0m10:21:26.218813 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.220472 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.221169 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.high_value_customers
[0m10:21:26.222214 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.trip_summary_per_hour
[0m10:21:26.223388 [debug] [Thread-1  ]: Compiling model.nyc_taxi.high_value_customers
[0m10:21:26.224508 [debug] [Thread-2  ]: Compiling model.nyc_taxi.trip_summary_per_hour
[0m10:21:26.231159 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.high_value_customers"
[0m10:21:26.235796 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.242518 [debug] [Thread-2  ]: finished collecting timing info
[0m10:21:26.244297 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.trip_summary_per_hour
[0m10:21:26.244676 [debug] [Thread-1  ]: finished collecting timing info
[0m10:21:26.251908 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.252893 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.high_value_customers
[0m10:21:26.264014 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.high_value_customers"
[0m10:21:26.268712 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.270100 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: BEGIN
[0m10:21:26.271524 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:21:26.272180 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.274685 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: BEGIN
[0m10:21:26.275620 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:21:26.279633 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m10:21:26.281257 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.282114 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE pickup_hour IS NOT NULL
      AND trip_duration_minutes IS NOT NULL
      AND fare_amount IS NOT NULL
)

SELECT
    pickup_hour,
    COALESCE(weather_category, 'Unknown') as weather_category,
    COUNT(*) AS num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(AVG(trip_duration_minutes) AS DECIMAL(10,2)) AS avg_trip_duration,
    CAST(AVG(COALESCE(tip_percentage, 0)) AS DECIMAL(10,2)) AS avg_tip_percentage,
    CAST(AVG(fare_amount) AS DECIMAL(10,2)) AS avg_fare_amount,
    CAST(AVG(COALESCE(distance_km, 0)) AS DECIMAL(10,2)) AS avg_distance,
    
    -- Statistiques supplémentaires
    MIN(fare_amount) as min_fare,
    MAX(fare_amount) as max_fare,
    CAST(STDDEV(fare_amount) AS DECIMAL(10,2)) as stddev_fare
FROM trip_data
GROUP BY pickup_hour, COALESCE(weather_category, 'Unknown')
HAVING COUNT(*) >= 1  -- Au moins 1 trip par groupe
ORDER BY pickup_hour, num_trips DESC
  );
  
[0m10:21:26.282310 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m10:21:26.283588 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.284249 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */

  
    

  create  table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE fare_amount IS NOT NULL 
      AND tip_amount IS NOT NULL
      AND passenger_count IS NOT NULL
      AND passenger_count > 0
),

customer_stats AS (
    SELECT
        -- Utiliser passenger_count et pickup_location_id comme proxy pour identifier les "clients"
        passenger_count,
        pickup_location_id,
        COUNT(*) AS num_trips,
        SUM(fare_amount + COALESCE(tip_amount, 0)) AS total_spent,
        AVG(COALESCE(tip_percentage, 0)) AS avg_tip_percentage
    FROM trip_data
    GROUP BY passenger_count, pickup_location_id
    HAVING COUNT(*) > 0  -- Au moins 1 trip pour éviter les divisions par zéro
)

SELECT
    passenger_count,
    pickup_location_id,
    num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(total_spent AS DECIMAL(10,2)) as total_spent,
    CAST(avg_tip_percentage AS DECIMAL(10,2)) as avg_tip_percentage,
    
    -- Critères ajustés pour l'échantillon
    CASE 
        WHEN num_trips >= 5 AND total_spent >= 100 AND avg_tip_percentage >= 12 
        THEN 'High Value Customer'
        ELSE 'Regular Customer'
    END as customer_category
FROM customer_stats
WHERE 
    num_trips >= 2  -- Ajusté pour l'échantillon (au lieu de 10)
    AND total_spent >= 50  -- Ajusté pour l'échantillon (au lieu de 300)
    AND avg_tip_percentage >= 10  -- Ajusté pour l'échantillon (au lieu de 15)
ORDER BY total_spent DESC
  );
  
[0m10:21:26.289482 [debug] [Thread-2  ]: SQL status: SELECT 24 in 0.01 seconds
[0m10:21:26.296797 [debug] [Thread-1  ]: SQL status: SELECT 45 in 0.01 seconds
[0m10:21:26.297399 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.301467 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.302632 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour" rename to "trip_summary_per_hour__dbt_backup"
[0m10:21:26.303470 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
alter table "nyc_taxi_db"."public"."high_value_customers" rename to "high_value_customers__dbt_backup"
[0m10:21:26.304769 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.305891 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.310120 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.314461 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.315324 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp" rename to "trip_summary_per_hour"
[0m10:21:26.316178 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
alter table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp" rename to "high_value_customers"
[0m10:21:26.317569 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.318667 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m10:21:26.321851 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m10:21:26.325752 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: COMMIT
[0m10:21:26.326697 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.327515 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.328339 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m10:21:26.329272 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: COMMIT
[0m10:21:26.331402 [debug] [Thread-2  ]: SQL status: COMMIT in 0.0 seconds
[0m10:21:26.332128 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m10:21:26.334983 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m10:21:26.338479 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m10:21:26.339507 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
drop table if exists "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_backup" cascade
[0m10:21:26.340412 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
drop table if exists "nyc_taxi_db"."public"."high_value_customers__dbt_backup" cascade
[0m10:21:26.343848 [debug] [Thread-2  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:21:26.345965 [debug] [Thread-2  ]: finished collecting timing info
[0m10:21:26.346142 [debug] [Thread-1  ]: SQL status: DROP TABLE in 0.0 seconds
[0m10:21:26.346834 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: Close
[0m10:21:26.348874 [debug] [Thread-1  ]: finished collecting timing info
[0m10:21:26.350548 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802992eb0>]}
[0m10:21:26.351183 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: Close
[0m10:21:26.352399 [info ] [Thread-2  ]: 5 of 5 OK created sql table model public.trip_summary_per_hour ................. [[32mSELECT 24[0m in 0.13s]
[0m10:21:26.354081 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45064add-d14a-45b7-a44a-706e8802c5bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc802cb4280>]}
[0m10:21:26.355172 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.trip_summary_per_hour
[0m10:21:26.356187 [info ] [Thread-1  ]: 4 of 5 OK created sql table model public.high_value_customers .................. [[32mSELECT 45[0m in 0.14s]
[0m10:21:26.358513 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.high_value_customers
[0m10:21:26.361469 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m10:21:26.362389 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:26.363217 [debug] [MainThread]: On master: BEGIN
[0m10:21:26.364014 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m10:21:26.371118 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m10:21:26.372168 [debug] [MainThread]: On master: COMMIT
[0m10:21:26.373076 [debug] [MainThread]: Using postgres connection "master"
[0m10:21:26.374058 [debug] [MainThread]: On master: COMMIT
[0m10:21:26.375024 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m10:21:26.375811 [debug] [MainThread]: On master: Close
[0m10:21:26.377181 [info ] [MainThread]: 
[0m10:21:26.378157 [info ] [MainThread]: Finished running 2 view models, 3 table models in 0 hours 0 minutes and 0.84 seconds (0.84s).
[0m10:21:26.379297 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:21:26.380245 [debug] [MainThread]: Connection 'model.nyc_taxi.high_value_customers' was properly closed.
[0m10:21:26.381032 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_summary_per_hour' was properly closed.
[0m10:21:26.381819 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_enriched' was properly closed.
[0m10:21:26.400482 [info ] [MainThread]: 
[0m10:21:26.401603 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:21:26.402889 [info ] [MainThread]: 
[0m10:21:26.403983 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m10:21:26.405279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8029afd60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8029af580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8029af1f0>]}
[0m10:21:26.406598 [debug] [MainThread]: Flushing usage events


============================== 2025-05-22 14:56:43.449529 | 6909c801-4b43-405b-be6e-838f0522eded ==============================
[0m14:56:43.449561 [info ] [MainThread]: Running with dbt=1.3.0
[0m14:56:43.451153 [debug] [MainThread]: running dbt with arguments {'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/usr/app/dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}
[0m14:56:43.452927 [debug] [MainThread]: Tracking: tracking
[0m14:56:43.466785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e3590850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e3590730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e3590790>]}
[0m14:56:43.821179 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:56:43.822298 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:56:43.835114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e31640d0>]}
[0m14:56:43.855245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e351f400>]}
[0m14:56:43.856819 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 289 macros, 0 operations, 0 seed files, 2 sources, 0 exposures, 0 metrics
[0m14:56:43.858087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e351f100>]}
[0m14:56:43.862478 [info ] [MainThread]: 
[0m14:56:43.865191 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m14:56:43.869119 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db"
[0m14:56:43.926921 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db"
[0m14:56:43.928324 [debug] [ThreadPool]: On list_nyc_taxi_db: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db"} */

    select distinct nspname from pg_namespace
  
[0m14:56:43.929538 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:56:43.957530 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.03 seconds
[0m14:56:43.959905 [debug] [ThreadPool]: On list_nyc_taxi_db: Close
[0m14:56:43.963385 [debug] [ThreadPool]: Acquiring new postgres connection "list_nyc_taxi_db_public"
[0m14:56:43.972813 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m14:56:43.974118 [debug] [ThreadPool]: On list_nyc_taxi_db_public: BEGIN
[0m14:56:43.974970 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:56:43.981653 [debug] [ThreadPool]: SQL status: BEGIN in 0.01 seconds
[0m14:56:43.983172 [debug] [ThreadPool]: Using postgres connection "list_nyc_taxi_db_public"
[0m14:56:43.984431 [debug] [ThreadPool]: On list_nyc_taxi_db_public: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "list_nyc_taxi_db_public"} */
select
      'nyc_taxi_db' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'nyc_taxi_db' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  
[0m14:56:43.993369 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.01 seconds
[0m14:56:43.995942 [debug] [ThreadPool]: On list_nyc_taxi_db_public: ROLLBACK
[0m14:56:43.997100 [debug] [ThreadPool]: On list_nyc_taxi_db_public: Close
[0m14:56:44.005556 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:44.006808 [debug] [MainThread]: On master: BEGIN
[0m14:56:44.007736 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:56:44.015105 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m14:56:44.017301 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:44.019824 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:56:44.032728 [debug] [MainThread]: SQL status: SELECT 0 in 0.01 seconds
[0m14:56:44.035576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e31acdc0>]}
[0m14:56:44.037198 [debug] [MainThread]: On master: ROLLBACK
[0m14:56:44.038539 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:44.039914 [debug] [MainThread]: On master: BEGIN
[0m14:56:44.042025 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:56:44.044026 [debug] [MainThread]: On master: COMMIT
[0m14:56:44.046130 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:44.047284 [debug] [MainThread]: On master: COMMIT
[0m14:56:44.048506 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:56:44.049511 [debug] [MainThread]: On master: Close
[0m14:56:44.051125 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m14:56:44.052733 [info ] [MainThread]: 
[0m14:56:44.079860 [debug] [Thread-1  ]: Began running node model.nyc_taxi.source_dim_weather
[0m14:56:44.080165 [debug] [Thread-2  ]: Began running node model.nyc_taxi.source_fact_taxi_trips
[0m14:56:44.081585 [info ] [Thread-1  ]: 1 of 5 START sql view model public.source_dim_weather .......................... [RUN]
[0m14:56:44.082715 [info ] [Thread-2  ]: 2 of 5 START sql view model public.source_fact_taxi_trips ...................... [RUN]
[0m14:56:44.084462 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.086659 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.087484 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.source_dim_weather
[0m14:56:44.088731 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.source_fact_taxi_trips
[0m14:56:44.089988 [debug] [Thread-1  ]: Compiling model.nyc_taxi.source_dim_weather
[0m14:56:44.091117 [debug] [Thread-2  ]: Compiling model.nyc_taxi.source_fact_taxi_trips
[0m14:56:44.096960 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.source_dim_weather"
[0m14:56:44.102981 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.111839 [debug] [Thread-1  ]: finished collecting timing info
[0m14:56:44.113902 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.source_dim_weather
[0m14:56:44.114916 [debug] [Thread-2  ]: finished collecting timing info
[0m14:56:44.139451 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.source_fact_taxi_trips
[0m14:56:44.191035 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.191616 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.source_dim_weather"
[0m14:56:44.200590 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.202557 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: BEGIN
[0m14:56:44.204612 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.205225 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:56:44.206672 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: BEGIN
[0m14:56:44.209392 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:56:44.215671 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m14:56:44.217614 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.218000 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m14:56:44.221144 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */

  create view "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" as (
    

-- Échantillonnage stratifié pour conserver la représentativité
WITH taxi_sample AS (
    SELECT 
        *,
        -- Utiliser NTILE pour créer des groupes stratifiés par heure et jour
        NTILE(1000) OVER (
            PARTITION BY pickup_hour, pickup_day_of_week 
            ORDER BY pickup_datetime
        ) as sample_group
    FROM "nyc_taxi_db"."public"."fact_taxi_trips"
    WHERE 
        -- Filtrer sur une période spécifique pour réduire encore plus si nécessaire
        pickup_datetime >= '2022-01-01'
        AND pickup_datetime < '2022-04-01'  -- 3 mois au lieu de 2 ans
),

-- Prendre seulement les 3 premiers groupes de chaque strate (≈ 0.3% des données)
representative_sample AS (
    SELECT 
        pickup_datetime,
        dropoff_datetime,
        trip_duration_minutes,
        distance_km,
        distance_bucket,
        fare_amount,
        tip_amount,
        tip_percentage,
        payment_type,
        pickup_hour,
        pickup_day_of_week,
        passenger_count,
        pickup_location_id,
        dropoff_location_id
    FROM taxi_sample
    WHERE sample_group <= 3  -- Prendre seulement les 3 premiers groupes
)

SELECT * FROM representative_sample
  );
[0m14:56:44.222419 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.224812 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */

  create view "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" as (
    

SELECT
    timestamp,
    temperature,
    humidity,
    wind_speed,
    weather_condition,
    weather_description,
    weather_category,
    hour_of_day,
    day_of_week
FROM
    "nyc_taxi_db"."public"."dim_weather"
  );
[0m14:56:44.230629 [debug] [Thread-1  ]: SQL status: CREATE VIEW in 0.0 seconds
[0m14:56:44.243388 [debug] [Thread-2  ]: SQL status: CREATE VIEW in 0.02 seconds
[0m14:56:44.244457 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.248920 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.250115 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
alter table "nyc_taxi_db"."public"."source_dim_weather__dbt_tmp" rename to "source_dim_weather"
[0m14:56:44.251070 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
alter table "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_tmp" rename to "source_fact_taxi_trips"
[0m14:56:44.253554 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:56:44.253819 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:56:44.285642 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m14:56:44.288333 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m14:56:44.289283 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.290551 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.291828 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: COMMIT
[0m14:56:44.293068 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: COMMIT
[0m14:56:44.295721 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m14:56:44.296515 [debug] [Thread-2  ]: SQL status: COMMIT in 0.0 seconds
[0m14:56:44.304960 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.source_dim_weather"
[0m14:56:44.308487 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.source_fact_taxi_trips"
[0m14:56:44.310006 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_dim_weather"} */
drop view if exists "nyc_taxi_db"."public"."source_dim_weather__dbt_backup" cascade
[0m14:56:44.311325 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.source_fact_taxi_trips"} */
drop view if exists "nyc_taxi_db"."public"."source_fact_taxi_trips__dbt_backup" cascade
[0m14:56:44.313265 [debug] [Thread-1  ]: SQL status: DROP VIEW in 0.0 seconds
[0m14:56:44.314381 [debug] [Thread-2  ]: SQL status: DROP VIEW in 0.0 seconds
[0m14:56:44.316678 [debug] [Thread-1  ]: finished collecting timing info
[0m14:56:44.319179 [debug] [Thread-2  ]: finished collecting timing info
[0m14:56:44.320365 [debug] [Thread-1  ]: On model.nyc_taxi.source_dim_weather: Close
[0m14:56:44.321375 [debug] [Thread-2  ]: On model.nyc_taxi.source_fact_taxi_trips: Close
[0m14:56:44.323175 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e31230a0>]}
[0m14:56:44.325298 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e3123190>]}
[0m14:56:44.326619 [info ] [Thread-1  ]: 1 of 5 OK created sql view model public.source_dim_weather ..................... [[32mCREATE VIEW[0m in 0.24s]
[0m14:56:44.328051 [info ] [Thread-2  ]: 2 of 5 OK created sql view model public.source_fact_taxi_trips ................. [[32mCREATE VIEW[0m in 0.24s]
[0m14:56:44.329867 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.source_dim_weather
[0m14:56:44.331094 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.source_fact_taxi_trips
[0m14:56:44.335815 [debug] [Thread-4  ]: Began running node model.nyc_taxi.trip_enriched
[0m14:56:44.337780 [info ] [Thread-4  ]: 3 of 5 START sql table model public.trip_enriched .............................. [RUN]
[0m14:56:44.339885 [debug] [Thread-4  ]: Acquiring new postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.341211 [debug] [Thread-4  ]: Began compiling node model.nyc_taxi.trip_enriched
[0m14:56:44.342406 [debug] [Thread-4  ]: Compiling model.nyc_taxi.trip_enriched
[0m14:56:44.349925 [debug] [Thread-4  ]: Writing injected SQL for node "model.nyc_taxi.trip_enriched"
[0m14:56:44.362544 [debug] [Thread-4  ]: finished collecting timing info
[0m14:56:44.364194 [debug] [Thread-4  ]: Began executing node model.nyc_taxi.trip_enriched
[0m14:56:44.401069 [debug] [Thread-4  ]: Writing runtime sql for node "model.nyc_taxi.trip_enriched"
[0m14:56:44.413290 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.414545 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: BEGIN
[0m14:56:44.415476 [debug] [Thread-4  ]: Opening a new connection, currently in state init
[0m14:56:44.423727 [debug] [Thread-4  ]: SQL status: BEGIN in 0.01 seconds
[0m14:56:44.425069 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.426204 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp"
  as (
    

WITH taxi_trips AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_fact_taxi_trips"
),

weather AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."source_dim_weather"
),

-- Créer une jointure simple basée sur l'heure et le jour
weather_simplified AS (
    SELECT 
        hour_of_day,
        day_of_week,
        AVG(temperature) as avg_temperature,
        AVG(humidity) as avg_humidity,
        AVG(wind_speed) as avg_wind_speed,
        -- Utiliser la première valeur non-null pour les catégories
        MIN(weather_condition) as weather_condition,
        MIN(weather_category) as weather_category
    FROM weather
    WHERE temperature IS NOT NULL 
      AND hour_of_day IS NOT NULL 
      AND day_of_week IS NOT NULL
    GROUP BY hour_of_day, day_of_week
)

SELECT
    t.pickup_datetime,
    t.dropoff_datetime,
    t.trip_duration_minutes,
    t.distance_km,
    t.distance_bucket,
    t.fare_amount,
    t.tip_amount,
    t.tip_percentage,
    t.payment_type,
    t.pickup_hour,
    t.pickup_day_of_week,
    t.passenger_count,
    t.pickup_location_id,
    t.dropoff_location_id,
    
    -- Données météo jointées
    w.avg_temperature as temperature,
    w.avg_humidity as humidity,
    w.avg_wind_speed as wind_speed,
    w.weather_condition,
    w.weather_category
FROM
    taxi_trips t
LEFT JOIN
    weather_simplified w
    -- Jointure simple sur heure et jour de la semaine
    ON t.pickup_hour = w.hour_of_day 
    AND t.pickup_day_of_week = w.day_of_week
  );
  
[0m14:56:44.821468 [debug] [Thread-4  ]: SQL status: SELECT 837 in 0.39 seconds
[0m14:56:44.830304 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.831573 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
alter table "nyc_taxi_db"."public"."trip_enriched__dbt_tmp" rename to "trip_enriched"
[0m14:56:44.833365 [debug] [Thread-4  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:56:44.844175 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m14:56:44.845542 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.846664 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: COMMIT
[0m14:56:44.849048 [debug] [Thread-4  ]: SQL status: COMMIT in 0.0 seconds
[0m14:56:44.854934 [debug] [Thread-4  ]: Using postgres connection "model.nyc_taxi.trip_enriched"
[0m14:56:44.856413 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_enriched"} */
drop table if exists "nyc_taxi_db"."public"."trip_enriched__dbt_backup" cascade
[0m14:56:44.858502 [debug] [Thread-4  ]: SQL status: DROP TABLE in 0.0 seconds
[0m14:56:44.861393 [debug] [Thread-4  ]: finished collecting timing info
[0m14:56:44.862676 [debug] [Thread-4  ]: On model.nyc_taxi.trip_enriched: Close
[0m14:56:44.864468 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e2dc7d90>]}
[0m14:56:44.866001 [info ] [Thread-4  ]: 3 of 5 OK created sql table model public.trip_enriched ......................... [[32mSELECT 837[0m in 0.53s]
[0m14:56:44.867539 [debug] [Thread-4  ]: Finished running node model.nyc_taxi.trip_enriched
[0m14:56:44.870336 [debug] [Thread-1  ]: Began running node model.nyc_taxi.high_value_customers
[0m14:56:44.870760 [debug] [Thread-2  ]: Began running node model.nyc_taxi.trip_summary_per_hour
[0m14:56:44.872110 [info ] [Thread-1  ]: 4 of 5 START sql table model public.high_value_customers ....................... [RUN]
[0m14:56:44.873435 [info ] [Thread-2  ]: 5 of 5 START sql table model public.trip_summary_per_hour ...................... [RUN]
[0m14:56:44.875812 [debug] [Thread-1  ]: Acquiring new postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:44.877705 [debug] [Thread-2  ]: Acquiring new postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:44.878759 [debug] [Thread-1  ]: Began compiling node model.nyc_taxi.high_value_customers
[0m14:56:44.881747 [debug] [Thread-2  ]: Began compiling node model.nyc_taxi.trip_summary_per_hour
[0m14:56:44.883450 [debug] [Thread-1  ]: Compiling model.nyc_taxi.high_value_customers
[0m14:56:44.884686 [debug] [Thread-2  ]: Compiling model.nyc_taxi.trip_summary_per_hour
[0m14:56:44.892346 [debug] [Thread-1  ]: Writing injected SQL for node "model.nyc_taxi.high_value_customers"
[0m14:56:44.900391 [debug] [Thread-2  ]: Writing injected SQL for node "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:44.909572 [debug] [Thread-1  ]: finished collecting timing info
[0m14:56:44.913124 [debug] [Thread-1  ]: Began executing node model.nyc_taxi.high_value_customers
[0m14:56:44.913742 [debug] [Thread-2  ]: finished collecting timing info
[0m14:56:44.924029 [debug] [Thread-1  ]: Writing runtime sql for node "model.nyc_taxi.high_value_customers"
[0m14:56:44.925021 [debug] [Thread-2  ]: Began executing node model.nyc_taxi.trip_summary_per_hour
[0m14:56:44.960916 [debug] [Thread-2  ]: Writing runtime sql for node "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:44.968328 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:44.970361 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: BEGIN
[0m14:56:44.971864 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:56:44.981976 [debug] [Thread-1  ]: SQL status: BEGIN in 0.01 seconds
[0m14:56:45.001338 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:45.029285 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:45.032186 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: BEGIN
[0m14:56:45.035695 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */

  
    

  create  table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE fare_amount IS NOT NULL 
      AND tip_amount IS NOT NULL
      AND passenger_count IS NOT NULL
      AND passenger_count > 0
),

customer_stats AS (
    SELECT
        -- Utiliser passenger_count et pickup_location_id comme proxy pour identifier les "clients"
        passenger_count,
        pickup_location_id,
        COUNT(*) AS num_trips,
        SUM(fare_amount + COALESCE(tip_amount, 0)) AS total_spent,
        AVG(COALESCE(tip_percentage, 0)) AS avg_tip_percentage
    FROM trip_data
    GROUP BY passenger_count, pickup_location_id
    HAVING COUNT(*) > 0  -- Au moins 1 trip pour éviter les divisions par zéro
)

SELECT
    passenger_count,
    pickup_location_id,
    num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(total_spent AS DECIMAL(10,2)) as total_spent,
    CAST(avg_tip_percentage AS DECIMAL(10,2)) as avg_tip_percentage,
    
    -- Critères ajustés pour l'échantillon
    CASE 
        WHEN num_trips >= 5 AND total_spent >= 100 AND avg_tip_percentage >= 12 
        THEN 'High Value Customer'
        ELSE 'Regular Customer'
    END as customer_category
FROM customer_stats
WHERE 
    num_trips >= 2  -- Ajusté pour l'échantillon (au lieu de 10)
    AND total_spent >= 50  -- Ajusté pour l'échantillon (au lieu de 300)
    AND avg_tip_percentage >= 10  -- Ajusté pour l'échantillon (au lieu de 15)
ORDER BY total_spent DESC
  );
  
[0m14:56:45.039876 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:56:45.054286 [debug] [Thread-2  ]: SQL status: BEGIN in 0.01 seconds
[0m14:56:45.055919 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:45.057082 [debug] [Thread-1  ]: SQL status: SELECT 56 in 0.02 seconds
[0m14:56:45.057428 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */

  
    

  create  table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp"
  as (
    

WITH trip_data AS (
    SELECT *
    FROM "nyc_taxi_db"."public"."trip_enriched"
    WHERE pickup_hour IS NOT NULL
      AND trip_duration_minutes IS NOT NULL
      AND fare_amount IS NOT NULL
)

SELECT
    pickup_hour,
    COALESCE(weather_category, 'Unknown') as weather_category,
    COUNT(*) AS num_trips,
    -- Utiliser CAST au lieu de ROUND pour PostgreSQL
    CAST(AVG(trip_duration_minutes) AS DECIMAL(10,2)) AS avg_trip_duration,
    CAST(AVG(COALESCE(tip_percentage, 0)) AS DECIMAL(10,2)) AS avg_tip_percentage,
    CAST(AVG(fare_amount) AS DECIMAL(10,2)) AS avg_fare_amount,
    CAST(AVG(COALESCE(distance_km, 0)) AS DECIMAL(10,2)) AS avg_distance,
    
    -- Statistiques supplémentaires
    MIN(fare_amount) as min_fare,
    MAX(fare_amount) as max_fare,
    CAST(STDDEV(fare_amount) AS DECIMAL(10,2)) as stddev_fare
FROM trip_data
GROUP BY pickup_hour, COALESCE(weather_category, 'Unknown')
HAVING COUNT(*) >= 1  -- Au moins 1 trip par groupe
ORDER BY pickup_hour, num_trips DESC
  );
  
[0m14:56:45.066000 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:45.073691 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
alter table "nyc_taxi_db"."public"."high_value_customers__dbt_tmp" rename to "high_value_customers"
[0m14:56:45.075821 [debug] [Thread-1  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:56:45.081036 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: COMMIT
[0m14:56:45.081361 [debug] [Thread-2  ]: SQL status: SELECT 24 in 0.01 seconds
[0m14:56:45.082836 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:45.091781 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:45.093677 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: COMMIT
[0m14:56:45.095047 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
alter table "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_tmp" rename to "trip_summary_per_hour"
[0m14:56:45.098911 [debug] [Thread-1  ]: SQL status: COMMIT in 0.0 seconds
[0m14:56:45.100171 [debug] [Thread-2  ]: SQL status: ALTER TABLE in 0.0 seconds
[0m14:56:45.107434 [debug] [Thread-1  ]: Using postgres connection "model.nyc_taxi.high_value_customers"
[0m14:56:45.112652 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m14:56:45.114107 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.high_value_customers"} */
drop table if exists "nyc_taxi_db"."public"."high_value_customers__dbt_backup" cascade
[0m14:56:45.115503 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:45.117326 [debug] [Thread-1  ]: SQL status: DROP TABLE in 0.0 seconds
[0m14:56:45.117750 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: COMMIT
[0m14:56:45.120718 [debug] [Thread-1  ]: finished collecting timing info
[0m14:56:45.123340 [debug] [Thread-1  ]: On model.nyc_taxi.high_value_customers: Close
[0m14:56:45.124333 [debug] [Thread-2  ]: SQL status: COMMIT in 0.0 seconds
[0m14:56:45.126146 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e3070f40>]}
[0m14:56:45.134114 [debug] [Thread-2  ]: Using postgres connection "model.nyc_taxi.trip_summary_per_hour"
[0m14:56:45.136102 [info ] [Thread-1  ]: 4 of 5 OK created sql table model public.high_value_customers .................. [[32mSELECT 56[0m in 0.25s]
[0m14:56:45.137098 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: /* {"app": "dbt", "dbt_version": "1.3.0", "profile_name": "nyc_taxi", "target_name": "dev", "node_id": "model.nyc_taxi.trip_summary_per_hour"} */
drop table if exists "nyc_taxi_db"."public"."trip_summary_per_hour__dbt_backup" cascade
[0m14:56:45.139136 [debug] [Thread-1  ]: Finished running node model.nyc_taxi.high_value_customers
[0m14:56:45.140853 [debug] [Thread-2  ]: SQL status: DROP TABLE in 0.0 seconds
[0m14:56:45.147015 [debug] [Thread-2  ]: finished collecting timing info
[0m14:56:45.148235 [debug] [Thread-2  ]: On model.nyc_taxi.trip_summary_per_hour: Close
[0m14:56:45.150397 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6909c801-4b43-405b-be6e-838f0522eded', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e2debfd0>]}
[0m14:56:45.152484 [info ] [Thread-2  ]: 5 of 5 OK created sql table model public.trip_summary_per_hour ................. [[32mSELECT 24[0m in 0.27s]
[0m14:56:45.155242 [debug] [Thread-2  ]: Finished running node model.nyc_taxi.trip_summary_per_hour
[0m14:56:45.160394 [debug] [MainThread]: Acquiring new postgres connection "master"
[0m14:56:45.163043 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:45.164563 [debug] [MainThread]: On master: BEGIN
[0m14:56:45.166069 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m14:56:45.177677 [debug] [MainThread]: SQL status: BEGIN in 0.01 seconds
[0m14:56:45.179640 [debug] [MainThread]: On master: COMMIT
[0m14:56:45.181212 [debug] [MainThread]: Using postgres connection "master"
[0m14:56:45.182360 [debug] [MainThread]: On master: COMMIT
[0m14:56:45.183986 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m14:56:45.185076 [debug] [MainThread]: On master: Close
[0m14:56:45.187464 [info ] [MainThread]: 
[0m14:56:45.189675 [info ] [MainThread]: Finished running 2 view models, 3 table models in 0 hours 0 minutes and 1.32 seconds (1.32s).
[0m14:56:45.191023 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:56:45.192276 [debug] [MainThread]: Connection 'model.nyc_taxi.high_value_customers' was properly closed.
[0m14:56:45.194130 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_summary_per_hour' was properly closed.
[0m14:56:45.196010 [debug] [MainThread]: Connection 'model.nyc_taxi.trip_enriched' was properly closed.
[0m14:56:45.220574 [info ] [MainThread]: 
[0m14:56:45.222365 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:56:45.225742 [info ] [MainThread]: 
[0m14:56:45.227735 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
[0m14:56:45.230576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e30e6ee0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e30e6f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3e2dab790>]}
[0m14:56:45.232002 [debug] [MainThread]: Flushing usage events
